pipeline {
  agent any
  environment {
    PORT = "8085"          // cambia si está ocupado
    PID_FILE = ".php.pid"
  }
  options { timestamps() }

  stages {
    stage('Preparar Hola Mundo') {
      steps {
        sh '''
          set -e
          echo "<?php echo '¡Hola Mundo desde PHP!'; ?>" > index.php
        '''
      }
    }

    stage('Levantar server y mostrar URL') {
      steps {
        sh '''
          set -eux

          # Cerrar instancia previa si existiera
          [ -f "${PID_FILE}" ] && kill "$(cat ${PID_FILE})" 2>/dev/null || true

          # IP del agente (primera IPv4 no loopback)
          IP="$(hostname -I 2>/dev/null | awk '{print $1}')"
          if [ -z "$IP" ]; then
            IP="$(ip -4 addr show | awk '/inet/{print $2}' | cut -d/ -f1 | grep -v '^127\\.' | head -n1)"
          fi
          [ -z "$IP" ] && IP="(IP-del-agente)"

          # Levantar servidor accesible por red
          nohup php -S 0.0.0.0:${PORT} -t . > /tmp/php-server.log 2>&1 &
          echo $! > "${PID_FILE}"

          echo "==============================================="
          echo " Abre en tu navegador:  http://${IP}:${PORT}/"
          echo " (desde tu PC debes usar la IP del AGENTE, no localhost)"
          echo " Mantendré el server activo por 5 minutos..."
          echo "==============================================="

          # Espera a que responda
          for i in $(seq 1 30); do
            curl -fsS "http://127.0.0.1:${PORT}/" >/dev/null && break || sleep 1
          done

          # Smoke test
          curl -fsS "http://127.0.0.1:${PORT}/" | grep -i "hola mundo"

          # Mantener vivo 5 minutos para que puedas probarlo
          sleep 300
        '''
      }
    }
  }

  post {
    always {
      sh '''
        echo "---- últimos logs ----"
        tail -n 50 /tmp/php-server.log || true
        [ -f "${PID_FILE}" ] && kill "$(cat ${PID_FILE})" 2>/dev/null || true
        rm -f "${PID_FILE}" || true
      '''
    }
  }
}